pipeline {
    agent any

environment {
        PATH = "/usr/local/bin:$PATH"
        COMPOSE_VERSION = "2.24.6"  // Replace with the desired Docker Compose version
        INSTALL_DIR = "${JENKINS_HOME}/tools/docker-compose"
    }

    stages {
        stage("Git checkout") {
            steps {    
            echo "Checking the Git Repo"
            git url: "https://github.com/Ashu210980/Django-Notes-App.git", branch: "main" 
            }
        }
        stage("Build") {
            steps {
            echo " Building the Image"
            sh " docker build -t my-note-app ." 
           }
        }
        stage("Push to Docker Hub"){
            steps {
            echo "Pushing the image to Docker Hub"
            withCredentials([usernamePassword(credentialsId:"dockerHub",passwordVariable:"dockerHubPass",usernameVariable:"dockerHubUser")]){
            sh "docker tag my-note-app ${env.dockerHubUser}/my-note-app:latest"
            sh "docker login -u ${env.dockerHubUser} -p ${env.dockerHubPass}"
            sh "docker push ${env.dockerHubUser}/my-note-app:latest"
            }
         }
      }
        stage("Install Docker Compose") {
            steps {
                script {
                    sh """
                        mkdir -p ${INSTALL_DIR}
                        curl -L "https://github.com/docker/compose/releases/download/${COMPOSE_VERSION}/docker-compose-\$(uname -s)-\$(uname -m)" -o ${INSTALL_DIR}/docker-compose
                        chmod +x ${INSTALL_DIR}/docker-compose
                        export PATH=${INSTALL_DIR}:$PATH
                    """
                }
            }
        }
      stage("Deploy"){
          steps {
          echo "Deploying the Container"
          sh "docker-compose down && docker-compose up -d"
        }
      }
   }
}
